<div id="auth-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm"
    hx-swap-oob="true">
    <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4 relative"
        @click.away="document.getElementById('auth-modal').innerHTML = ''" x-data="{
            email: '',
            isLoading: false,
            sent: false,
            error: '',
            async submit() {
                if (!this.email) return;
                this.isLoading = true;
                this.error = '';
                try {
                    const res = await fetch('/api/auth/magic-link', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: this.email, next_url: window.location.href })
                    });
                    if (res.ok) {
                        this.sent = true;
                    } else {
                        const data = await res.json();
                        this.error = data.detail || 'Failed to send link';
                    }
                } catch (e) {
                    this.error = 'Network error occurred';
                } finally {
                    this.isLoading = false;
                }
            }
        }">

        <button onclick="document.getElementById('auth-modal').innerHTML = ''"
            class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <!-- Initial Form State -->
        <div x-show="!sent">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Verify your Email</h2>
            <p class="text-gray-600 mb-6">
                To ensure the integrity of our records, we need to verify your email address before counting your
                vote/flag.
                Don't worry, it's just a one-time verify link!
            </p>

            <form @submit.prevent="submit" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" x-model="email" id="email" required
                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"
                        placeholder="you@school.edu">
                </div>

                <div x-show="error" class="text-red-600 text-sm" x-text="error"></div>

                <button type="submit" :disabled="isLoading"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition"
                    :class="{'opacity-50 cursor-not-allowed': isLoading}">
                    <span x-show="!isLoading">Send Magic Link</span>
                    <span x-show="isLoading">Sending...</span>
                </button>
            </form>
        </div>

        <!-- Success State -->
        <div x-show="sent" class="text-center py-4" style="display: none;">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900">Magic Link Sent!</h3>
            <div class="mt-2 px-2 py-3">
                <p class="text-sm text-gray-500">
                    Please check your email <strong><span x-text="email"></span></strong>.
                </p>
                <button onclick="document.getElementById('auth-modal').innerHTML = ''"
                    class="mt-6 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:w-auto sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>