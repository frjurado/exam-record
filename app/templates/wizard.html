<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Contribute - Exam Record</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-50 min-h-screen p-6" x-data="wizard({{ event_id }})">
    <!-- Loading Overlay -->
    <div x-show="isVerifying"
        class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-600 mb-4"></div>
        <h2 class="text-xl font-bold text-gray-800">Verificando...</h2>
        <p class="text-gray-500">Estamos validando tu enlace mágico y enviando la aportación.</p>
    </div>

    <!-- Success Overlay -->
    <div x-show="submitSuccess"
        class="fixed inset-0 bg-white bg-opacity-95 flex flex-col items-center justify-center z-50">
        <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-green-100 mb-6">
            <svg class="h-10 w-10 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">¡Aportación Enviada!</h2>
        <p class="text-gray-600 text-center mb-6 max-w-md">Gracias por contribuir al registro. Tu aportación ayuda a la
            comunidad.</p>
        <p class="text-sm text-gray-400">Redirigiendo en <span x-text="countdown"></span>...</p>
    </div>

    <div class="max-w-2xl mx-auto bg-white shadow rounded p-6">
        <h1 class="text-2xl font-bold mb-4">Asistente de Aportación</h1>

        <!-- Step Indicator -->
        <div class="mb-6 flex space-x-4 text-sm">
            <span :class="{'font-bold text-blue-600': step===1}">1. Compositor</span>
            <span :class="{'font-bold text-blue-600': step===2}">2. Obra</span>
            <span :class="{'font-bold text-blue-600': step===3}">3. Detalles</span>
        </div>

        <!-- Step 1: Composer -->
        <div x-show="step === 1">
            <h2 class="text-xl mb-4">¿Quién es el compositor?</h2>
            <input type="text" x-model="searchComposerQuery" @input.debounce.300ms="searchComposer"
                class="w-full border p-2 rounded" placeholder="Buscar compositor (ej. Bach)">

            <div class="mt-4 space-y-2">
                <template x-for="c in composerResults" :key="c.id || c.wikidata_id">
                    <div @click="selectComposer(c)"
                        class="p-2 border rounded hover:bg-gray-100 cursor-pointer flex justify-between items-center bg-gray-50">
                        <span x-text="c.name"></span>
                        <span x-show="c.is_verified" class="text-green-500 font-bold">✓</span>
                    </div>
                </template>
            </div>

            <div x-show="searchComposerQuery.length > 2" class="mt-4 pt-4 border-t">
                <p class="text-gray-500 text-sm mb-2" x-show="composerResults.length === 0">No se encontraron resultados
                    locales.</p>
                <div class="flex gap-4 items-center">
                    <button @click="searchWikidata" class="text-blue-600 underline text-sm">Buscar en Base Global
                        (Wikidata)</button>
                    <span class="text-gray-300">|</span>
                    <button @click="createUnverifiedComposer" class="text-gray-600 underline text-sm">Usar "<span
                            x-text="searchComposerQuery"></span>" (Sin Verificar)</button>
                </div>

                <div x-show="wikidataResults.length > 0" class="mt-4 bg-blue-50 p-4 rounded">
                    <h3 class="font-bold text-sm text-blue-800 mb-2">¿Quizás quisiste decir...?</h3>
                    <template x-for="c in wikidataResults" :key="c.wikidata_id">
                        <div @click="selectComposer(c)"
                            class="p-2 border border-blue-100 rounded bg-white hover:bg-blue-100 cursor-pointer mb-1">
                            <div class="font-bold" x-text="c.name"></div>
                            <div class="text-xs text-gray-600" x-text="c.description"></div>
                        </div>
                    </template>
                </div>
                <div x-show="searchComposerQuery.length > 2 && wikidataResults.length === 0 && wikidataSearched"
                    class="mt-4 text-gray-500 text-sm">
                    No se encontraron resultados en la base global.
                </div>
            </div>
        </div>

        <!-- Step 2: Work -->
        <div x-show="step === 2">
            <h2 class="text-xl mb-4">¿Qué obra?</h2>
            <p class="text-sm text-gray-500 mb-4">Compositor: <span class="font-bold text-gray-800"
                    x-text="selectedComposer ? selectedComposer.name : ''"></span></p>

            <input type="text" x-model="searchWorkQuery" @input.debounce.300ms="searchWork"
                class="w-full border p-2 rounded" placeholder="Buscar obra (ej. Preludio)">

            <div class="mt-4 space-y-2 max-h-60 overflow-y-auto">
                <template x-for="w in workResults" :key="w.id || w.openopus_id">
                    <div @click="selectWork(w)" class="p-2 border rounded hover:bg-gray-100 cursor-pointer bg-gray-50">
                        <span x-text="w.title"></span>
                        <span x-show="w.nickname" x-text="`(${w.nickname})`" class="text-xs text-gray-500 ml-1"></span>
                    </div>
                </template>
            </div>

            <!-- Lazy Builder Fallback -->
            <div x-show="searchWorkQuery.length > 2" class="mt-4 border p-4 rounded bg-gray-50">
                <h3 class="font-bold text-sm mb-2">¿No la encuentras? Crea una nueva entrada.</h3>
                <div class="space-y-3 mt-2">
                    <!-- Row 1: Genre & Nickname -->
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase">Género <span
                                    class="text-red-500">*</span></label>
                            <input type="text" x-model="lazyGenre" @input.debounce.500ms="updateLazySearch"
                                placeholder="ej. Sonata" class="w-full border p-2 rounded text-sm"
                                :class="{'border-red-300 bg-red-50': !lazyGenre && searchWorkQuery.length > 2}">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase">Título/Apodo
                                (Opcional)</label>
                            <input type="text" x-model="lazyNickname" @input.debounce.500ms="updateLazySearch"
                                placeholder='ej. "Pathetique"' class="w-full border p-2 rounded text-sm">
                        </div>
                    </div>

                    <!-- Row 2: Key (Split) -->
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase">Tonalidad</label>
                            <select x-model="lazyKeyNote" @change="updateLazySearch"
                                class="w-full border p-2 rounded text-sm bg-white">
                                <option value="">- Nota -</option>
                                <option value="Do">Do</option>
                                <option value="Do sostenido">Do#</option>
                                <option value="Re">Re</option>
                                <option value="Mi bemol">Mib</option>
                                <option value="Mi">Mi</option>
                                <option value="Fa">Fa</option>
                                <option value="Fa sostenido">Fa#</option>
                                <option value="Sol">Sol</option>
                                <option value="La bemol">Lab</option>
                                <option value="La">La</option>
                                <option value="Si bemol">Sib</option>
                                <option value="Si">Si</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase">Modo</label>
                            <select x-model="lazyKeyMode" @change="updateLazySearch"
                                class="w-full border p-2 rounded text-sm bg-white">
                                <option value="">- Modo -</option>
                                <option value="Mayor">Mayor</option>
                                <option value="Menor">Menor</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 3: Identifiers (Numeric) -->
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase">Opus/BWV/KV</label>
                            <input type="number" x-model="lazyOpus" @input.debounce.500ms="updateLazySearch"
                                placeholder="ej. 57" class="w-full border p-2 rounded text-sm">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase">Número</label>
                            <input type="number" x-model="lazyNumber" @input.debounce.500ms="updateLazySearch"
                                placeholder="ej. 23" class="w-full border p-2 rounded text-sm">
                        </div>
                    </div>
                </div>
                <button @click="createUnverifiedWork" :disabled="!lazyGenre"
                    :class="{'opacity-50 cursor-not-allowed': !lazyGenre}"
                    class="mt-4 bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 w-full transition">
                    Crear y Continuar
                </button>
            </div>

            <button @click="step=1; searchComposerQuery=''; composerResults=[]; wikidataResults=[]"
                class="mt-6 text-sm text-gray-500 underline">Volver a Compositor</button>
        </div>

        <!-- Step 3: Scope -->
        <div x-show="step === 3">
            <h2 class="text-xl mb-4">Detalles Finales</h2>
            <div class="mb-6 p-4 bg-blue-50 rounded border border-blue-100">
                <p class="mb-1"><span class="font-bold text-gray-600 w-24 inline-block">Compositor:</span> <span
                        x-text="selectedComposer ? selectedComposer.name : ''"></span></p>
                <p><span class="font-bold text-gray-600 w-24 inline-block">Obra:</span> <span
                        x-text="selectedWork ? selectedWork.title : ''"></span></p>
            </div>

            <!-- Scope Selection -->
            <label class="block mb-3 font-bold text-sm text-gray-700">Alcance de la Aportación</label>

            <div class="space-y-4 mb-6">
                <!-- Main Selector: Whole Work vs Movement -->
                <div class="flex gap-4">
                    <label
                        class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition flex-1"
                        :class="{'border-blue-500 bg-blue-50 ring-1 ring-blue-500': scopeType === 'Whole Work'}">
                        <input type="radio" x-model="scopeType" value="Whole Work" class="mr-3">
                        <span class="font-bold text-sm">Obra Completa</span>
                    </label>
                    <label
                        class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition flex-1"
                        :class="{'border-blue-500 bg-blue-50 ring-1 ring-blue-500': scopeType === 'Movement'}">
                        <input type="radio" x-model="scopeType" value="Movement" class="mr-3">
                        <span class="font-bold text-sm">Movimiento</span>
                    </label>
                </div>

                <!-- Movement Details (Conditional) -->
                <div x-show="scopeType === 'Movement'" class="p-4 border rounded bg-gray-50 space-y-3">
                    <div class="flex gap-2">
                        <div class="w-1/3">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nº</label>
                            <select x-model="movementNumber" class="w-full border p-2 rounded text-sm bg-white">
                                <option value="">-</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                            </select>
                        </div>
                        <div class="w-2/3">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre
                                (Opcional)</label>
                            <input type="text" x-model="movementName" placeholder="ej. Allegro ma non troppo"
                                class="w-full border p-2 rounded text-sm">
                        </div>
                    </div>
                </div>

                <!-- Excerpt Toggle (Orthogonal) -->
                <div class="pt-2 border-t mt-2">
                    <label class="flex items-start cursor-pointer">
                        <div class="flex items-center h-5">
                            <input type="checkbox" x-model="isExcerpt"
                                class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                        </div>
                        <div class="ml-3 text-sm">
                            <label class="font-bold text-gray-700 block">Es un fragmento / selección</label>
                            <span class="text-gray-500 text-xs">Marcar si solo se interpretó una parte (compases,
                                cadenza, etc.)</span>
                        </div>
                    </label>

                    <!-- Excerpt Details -->
                    <div x-show="isExcerpt" class="mt-3 pl-7">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Detalles del
                            fragmento</label>
                        <input type="text" x-model="excerptDetails" placeholder="ej. Compases 1-50, solo Cadenza"
                            class="w-full border p-2 rounded text-sm bg-yellow-50 border-yellow-200">
                    </div>
                </div>
            </div>

            <!-- Turnstile Widget -->
            <div class="mb-4 flex justify-center">
                <div class="cf-turnstile" data-sitekey="{{ turnstile_site_key }}" data-callback="onTurnstileSuccess">
                </div>
            </div>

            <button @click="submitReport"
                class="mt-6 bg-green-600 text-white px-6 py-3 rounded font-bold w-full hover:bg-green-700 shadow">Enviar
                Aportación</button>
            <div x-show="submitStatus" class="mt-4 p-4 rounded text-center"
                :class="submitSuccess ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                <p x-text="submitStatus"></p>
            </div>

            <div class="flex gap-4 mt-4">
                <button @click="step=2" class="text-sm text-gray-500 underline flex-1 text-center">Volver a
                    Obra</button>
                <button @click="hardReset" class="text-sm text-red-400 underline flex-1 text-center">Reiniciar
                    Formulario</button>
            </div>
        </div>
        <!-- Auth Modal -->
        <div x-show="showAuthModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"
            style="display: none;">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">

                <!-- Initial State: Ask for Email -->
                <div x-show="!magicLinkSent" class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Verificación de Email Requerida</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500">
                            Para mantener la calidad de los datos, por favor verifica tu email. Te enviaremos un enlace
                            mágico.
                        </p>
                        <input type="email" x-model="authEmail" class="mt-4 w-full border p-2 rounded"
                            placeholder="pianista@ejemplo.com">
                    </div>
                    <div class="items-center px-4 py-3">
                        <button @click="requestMagicLink" :disabled="!authEmail"
                            :class="{'opacity-50 cursor-not-allowed': !authEmail}"
                            class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                            Enviar Enlace Mágico
                        </button>
                        <button @click="showAuthModal = false"
                            class="mt-2 text-sm text-gray-500 underline">Cancelar</button>
                    </div>
                </div>

                <!-- Sent State: Instructions -->
                <div x-show="magicLinkSent" class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                        <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <h3 class="text-lg leading-6 font-medium text-gray-900">¡Enlace Mágico Enviado!</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500">
                            Por favor revisa tu email <strong><span x-text="authEmail"></span></strong>.
                        </p>
                        <p class="text-sm text-gray-500 mt-2">
                            Haz clic en el enlace del email para volver aquí y enviar tu reporte.
                        </p>
                        <div class="mt-4 p-2 bg-blue-50 text-xs text-blue-800 rounded text-left">
                            <strong>Siguiente:</strong> Haz clic en el enlace de tu email. Te traerá de vuelta aquí y
                            <strong>enviará tu reporte automáticamente</strong>.
                        </div>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button @click="showAuthModal = false"
                            class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">
                            Cerrar
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <script>
            function wizard(eventId) {
                return {
                    step: 1,
                    // Composer
                    searchComposerQuery: '',
                    composerResults: [],
                    wikidataResults: [],
                    wikidataSearched: false,
                    selectedComposer: null,

                    // Work
                    searchWorkQuery: '',
                    workResults: [],
                    selectedWork: null,
                    lazyGenre: '',
                    lazyNickname: '', // New
                    lazyKeyNote: '',
                    lazyKeyMode: '',
                    lazyOpus: '',
                    lazyNumber: '',

                    // Details
                    scopeType: 'Whole Work', // 'Whole Work' | 'Movement'
                    movementNumber: '',
                    movementName: '',
                    isExcerpt: false,
                    excerptDetails: '',

                    // Auth
                    isAuthenticated: false,
                    showAuthModal: false,
                    authEmail: '',
                    magicLinkSent: false,
                    pendingSubmission: false,

                    // Meta
                    submitStatus: '',
                    submitSuccess: false,
                    isVerifying: false,
                    countdown: 3,
                    eventId: eventId,
                    turnstileToken: '',

                    async init() {
                        this.restoreState();
                        await this.checkAuth();

                        // Watch for changes to persist state
                        this.$watch('step', () => this.saveState());
                        this.$watch('selectedComposer', () => this.saveState());
                        this.$watch('selectedWork', () => this.saveState());

                        this.$watch('lazyKeyNote', () => this.saveState());
                        this.$watch('lazyKeyMode', () => this.saveState());
                        this.$watch('lazyNickname', () => this.saveState());

                        // New Scope Watchers
                        this.$watch('scopeType', () => this.saveState());
                        this.$watch('movementNumber', () => this.saveState());
                        this.$watch('movementName', () => this.saveState());
                        this.$watch('isExcerpt', () => this.saveState());
                        this.$watch('excerptDetails', () => this.saveState());

                        // Global callback for Turnstile
                        window.onTurnstileSuccess = (token) => {
                            this.turnstileToken = token;
                        };

                        // Auto-submit check
                        if (this.isAuthenticated && this.step === 3 && this.pendingSubmission) {
                            console.log("Auto-submitting...");
                            this.isVerifying = true; // Show loading overlay
                            // Small delay to ensure UI renders
                            setTimeout(() => this.submitReport(), 500);
                        }
                    },

                    saveState() {
                        const state = {
                            step: this.step,
                            selectedComposer: this.selectedComposer,
                            selectedWork: this.selectedWork,
                            // Persist Lazy Builder
                            lazyGenre: this.lazyGenre,
                            lazyNickname: this.lazyNickname,
                            lazyKeyNote: this.lazyKeyNote,
                            lazyKeyMode: this.lazyKeyMode,
                            lazyOpus: this.lazyOpus,
                            lazyNumber: this.lazyNumber,

                            // Persist Scope
                            scopeType: this.scopeType,
                            movementNumber: this.movementNumber,
                            movementName: this.movementName,
                            isExcerpt: this.isExcerpt,
                            excerptDetails: this.excerptDetails,

                            eventId: this.eventId,
                            pendingSubmission: this.pendingSubmission || false
                        };
                        localStorage.setItem('wizardState_' + this.eventId, JSON.stringify(state));
                    },

                    restoreState() {
                        const saved = localStorage.getItem('wizardState_' + this.eventId);
                        if (saved) {
                            const state = JSON.parse(saved);
                            this.step = state.step || 1;
                            this.selectedComposer = state.selectedComposer;
                            this.selectedWork = state.selectedWork;
                            // Restore Lazy
                            this.lazyGenre = state.lazyGenre || '';
                            this.lazyNickname = state.lazyNickname || '';
                            this.lazyKeyNote = state.lazyKeyNote || '';
                            this.lazyKeyMode = state.lazyKeyMode || '';
                            this.lazyOpus = state.lazyOpus || '';
                            this.lazyNumber = state.lazyNumber || '';

                            // Restore Scope
                            this.scopeType = state.scopeType || 'Whole Work';
                            this.movementNumber = state.movementNumber || '';
                            this.movementName = state.movementName || '';
                            this.isExcerpt = state.isExcerpt || false;
                            this.excerptDetails = state.excerptDetails || '';

                            this.pendingSubmission = state.pendingSubmission || false;
                        }
                    },

                    clearState() {
                        localStorage.removeItem('wizardState_' + this.eventId);
                        // Also clear specific fields
                        this.step = 1;
                        this.selectedComposer = null;
                        this.selectedWork = null;
                        this.lazyGenre = '';
                        this.lazyNickname = '';
                        this.lazyKeyNote = '';
                        this.lazyKeyMode = '';
                        this.lazyOpus = '';
                        this.lazyNumber = '';

                        this.scopeType = 'Whole Work';
                        this.movementNumber = '';
                        this.movementName = '';
                        this.isExcerpt = false;
                        this.excerptDetails = '';

                        this.turnstileToken = '';
                        if (window.turnstile) window.turnstile.reset();
                    },

                    hardReset() {
                        if (confirm("¿Estás seguro de que quieres limpiar el formulario?")) {
                            this.clearState();
                            window.location.reload();
                        }
                    },

                    async checkAuth() {
                        try {
                            const res = await fetch('/api/auth/me', { credentials: 'include' });
                            if (res.ok) {
                                this.isAuthenticated = true;
                                if (this.step === 3) {
                                    // Optional: Auto-submit if desired, but safer to let user click
                                    this.submitStatus = "";
                                }
                            } else {
                                this.isAuthenticated = false;
                            }
                        } catch (e) {
                            this.isAuthenticated = false;
                        }
                    },

                    async requestMagicLink() {
                        if (!this.authEmail) return;
                        try {
                            const payload = {
                                email: this.authEmail,
                                next_url: window.location.href // This ensures we come back here
                            };

                            const res = await fetch('/api/auth/magic-link', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            if (res.ok) {
                                this.magicLinkSent = true;
                                this.pendingSubmission = true; // Mark intention to submit
                                this.saveState(); // Ensure state is saved before they leave
                            }
                        } catch (e) {
                            console.error("Magic link failed", e);
                        }
                    },

                    async searchComposer() {
                        if (this.searchComposerQuery.length < 2) {
                            this.composerResults = [];
                            this.wikidataResults = [];
                            return;
                        }
                        try {
                            const res = await fetch(`/api/composers/search?q=${this.searchComposerQuery}&source=local`);
                            if (res.ok) this.composerResults = await res.json();
                        } catch (e) { console.error(e); }
                    },

                    async searchWikidata() {
                        this.wikidataResults = [];
                        this.wikidataSearched = false;
                        try {
                            const res = await fetch(`/api/composers/search?q=${this.searchComposerQuery}&source=wikidata`);
                            this.wikidataSearched = true;
                            if (res.ok) {
                                this.wikidataResults = await res.json();
                            }
                        } catch (e) { console.error(e); }
                    },

                    selectComposer(c) {
                        this.selectedComposer = c;
                        this.searchWorkQuery = '';
                        this.workResults = [];
                        // Reset lazy builder
                        this.lazyGenre = '';
                        this.lazyNickname = '';
                        this.lazyKeyNote = '';
                        this.lazyKeyMode = '';
                        this.lazyOpus = '';
                        this.lazyNumber = '';
                        this.step = 2;
                    },

                    createUnverifiedComposer() {
                        const name = this.searchComposerQuery;
                        this.selectedComposer = { name: name, is_verified: false };
                        this.step = 2;
                    },

                    async searchWork() {
                        const query = this.searchWorkQuery;
                        if (query.length < 2) {
                            this.workResults = [];
                            return;
                        }

                        // Priority 1: OpenOpus Search (if validated link exists)
                        if (this.selectedComposer.openopus_id) {
                            try {
                                const url = `/api/works/search?q=${query}&source=openopus&composer_id=${this.selectedComposer.openopus_id}`;
                                const res = await fetch(url);
                                if (res.ok) this.workResults = await res.json();
                            } catch (e) {
                                console.error("OpenOpus search failed", e);
                                this.workResults = [];
                            }
                            return;
                        }

                        // Priority 2: Local Search (fallback)
                        if (this.selectedComposer.id) {
                            try {
                                const url = `/api/works/search?q=${query}&source=local&composer_id=${this.selectedComposer.id}`;
                                const res = await fetch(url);
                                if (res.ok) this.workResults = await res.json();
                            } catch (e) {
                                console.error("Local search failed", e);
                                this.workResults = [];
                            }
                            return;
                        }

                        // No ID available to search
                        this.workResults = [];
                    },

                    // Live search for Lazy Builder
                    updateLazySearch() {
                        const keyString = (this.lazyKeyNote && this.lazyKeyMode)
                            ? `${this.lazyKeyNote} ${this.lazyKeyMode}`
                            : (this.lazyKeyNote ? this.lazyKeyNote : '');

                        const parts = [
                            this.lazyGenre,
                            this.lazyNickname ? `"${this.lazyNickname}"` : '',
                            keyString,
                            this.lazyOpus ? 'Op. ' + this.lazyOpus : '',
                            this.lazyNumber ? 'No. ' + this.lazyNumber : ''
                        ];
                        // Join non-empty parts
                        const validParts = parts.filter(p => p && p.trim().length > 0);
                        const potentialTitle = validParts.join(' ');

                        if (potentialTitle.length > 2) {
                            this.searchWorkQuery = potentialTitle;
                            // Only search if we have a composer ID (Local or OpenOpus) to search against
                            if (this.selectedComposer.id || this.selectedComposer.openopus_id) {
                                this.searchWork();
                            } else {
                                this.workResults = [];
                            }
                        }
                    },

                    selectWork(w) {
                        this.selectedWork = w;
                        this.step = 3;
                    },

                    createUnverifiedWork() {
                        if (!this.lazyGenre) return; // Guard

                        const keyString = (this.lazyKeyNote && this.lazyKeyMode)
                            ? `${this.lazyKeyNote} ${this.lazyKeyMode}`
                            : (this.lazyKeyNote ? this.lazyKeyNote : '');

                        const parts = [
                            this.lazyGenre,
                            keyString ? 'en ' + keyString : '',
                            this.lazyOpus ? 'Op. ' + this.lazyOpus : '',
                            this.lazyNumber ? 'No. ' + this.lazyNumber : ''
                        ];
                        // "Sonata en Do Mayor Op. 57"
                        const title = parts.filter(p => p && p.trim().length > 0).join(' ').trim() || this.searchWorkQuery;

                        this.selectedWork = {
                            title: title,
                            nickname: this.lazyNickname,
                            is_verified: false
                        };
                        this.step = 3;
                    },

                    async submitReport() {
                        if (!this.isAuthenticated) {
                            this.showAuthModal = true;
                            return;
                        }

                        // Verify Turnstile
                        if (!this.turnstileToken && '{{ turnstile_site_key }}') {
                            this.isVerifying = false; // Fix: Stop loading overlay
                            this.submitStatus = "Por favor completa la verificación anti-spam.";
                            this.submitSuccess = false;

                            // Scroll to turnstile
                            const turnstileEl = document.querySelector('.cf-turnstile');
                            if (turnstileEl) turnstileEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

                            return;
                        }

                        // Map UI Scope to Backend Scope
                        let finalScope = 'Whole Work';
                        let finalDetails = null;

                        if (this.isExcerpt) {
                            finalScope = 'Excerpt'; // Backend Enum
                            // Construct complex detail string
                            let base = (this.scopeType === 'Movement')
                                ? `Mov. ${this.movementNumber || '?'} ${this.movementName ? '(' + this.movementName + ')' : ''}`
                                : 'Obra Completa';
                            finalDetails = `${base} - Fragmento: ${this.excerptDetails}`;
                        } else if (this.scopeType === 'Movement') {
                            finalScope = 'Movement';
                            finalDetails = `Mov. ${this.movementNumber || '?'} ${this.movementName ? '(' + this.movementName + ')' : ''}`.trim();
                        }

                        const payload = {
                            event_id: this.eventId,
                            composer: this.selectedComposer,
                            work: this.selectedWork,
                            scope: finalScope,
                            movement_details: finalDetails,
                            turnstile_token: this.turnstileToken
                        };

                        try {
                            const res = await fetch('/api/reports/', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload),
                                credentials: 'include'
                            });

                            if (res.ok) {
                                this.isVerifying = false;
                                this.submitSuccess = true;
                                this.clearState(); // Clear stored state on success

                                // Countdown timer
                                let timer = setInterval(() => {
                                    this.countdown--;
                                    if (this.countdown <= 0) {
                                        clearInterval(timer);
                                        window.location.href = window.location.href.replace('/contribute', '');
                                    }
                                }, 1000);
                            } else {
                                this.isVerifying = false;
                                const err = await res.json();
                                this.submitSuccess = false;
                                this.submitStatus = "Error: " + (err.detail || "Unknown error");
                            }
                        } catch (e) {
                            this.isVerifying = false;
                            this.submitSuccess = false;
                            this.submitStatus = "Error: Error de red";
                        }
                    }
                }
            }
        </script>
</body>

</html>