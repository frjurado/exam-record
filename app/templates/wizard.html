<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Contribute - Exam Record</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen p-6" x-data="wizard()">
    <div class="max-w-2xl mx-auto bg-white shadow rounded p-6">
        <h1 class="text-2xl font-bold mb-4">Exam Report Wizard</h1>
        
        <!-- Step Indicator -->
        <div class="mb-6 flex space-x-4 text-sm">
            <span :class="{'font-bold text-blue-600': step===1}">1. Composer</span>
            <span :class="{'font-bold text-blue-600': step===2}">2. Work</span>
            <span :class="{'font-bold text-blue-600': step===3}">3. Details</span>
        </div>

        <!-- Step 1: Composer -->
        <div x-show="step === 1">
            <h2 class="text-xl mb-4">Who is the composer?</h2>
            <input type="text" x-model="searchComposerQuery" @input.debounce.300ms="searchComposer" 
                   class="w-full border p-2 rounded" placeholder="Search composer (e.g. Bach)">
            
            <div class="mt-4 space-y-2">
                 <template x-for="c in composerResults" :key="c.id || c.wikidata_id">
                     <div @click="selectComposer(c)" class="p-2 border rounded hover:bg-gray-100 cursor-pointer flex justify-between items-center bg-gray-50">
                         <span x-text="c.name"></span>
                         <span x-show="c.is_verified" class="text-green-500 font-bold">âœ“</span>
                     </div>
                 </template>
            </div>
            
            <div x-show="searchComposerQuery.length > 2" class="mt-4 pt-4 border-t">
                <p class="text-gray-500 text-sm mb-2" x-show="composerResults.length === 0">No local results found.</p>
                <div class="flex gap-4 items-center">
                    <button @click="searchWikidata" class="text-blue-600 underline text-sm">Search Global Database (Wikidata)</button>
                    <span class="text-gray-300">|</span>
                    <button @click="createUnverifiedComposer" class="text-gray-600 underline text-sm">Use "{{ searchComposerQuery }}" (Unverified)</button>
                </div>

                <div x-show="wikidataResults.length > 0" class="mt-4 bg-blue-50 p-4 rounded">
                     <h3 class="font-bold text-sm text-blue-800 mb-2">Did you mean?</h3>
                     <template x-for="c in wikidataResults" :key="c.wikidata_id">
                         <div @click="selectComposer(c)" class="p-2 border border-blue-100 rounded bg-white hover:bg-blue-100 cursor-pointer mb-1">
                             <span x-text="c.name"></span> <span class="text-xs text-gray-500 ml-1">(Wikidata)</span>
                         </div>
                     </template>
                </div>
            </div>
        </div>

        <!-- Step 2: Work -->
        <div x-show="step === 2">
            <h2 class="text-xl mb-4">Which work?</h2>
            <p class="text-sm text-gray-500 mb-4">Composer: <span class="font-bold text-gray-800" x-text="selectedComposer ? selectedComposer.name : ''"></span></p>
            
            <input type="text" x-model="searchWorkQuery" @input.debounce.300ms="searchWork" 
                   class="w-full border p-2 rounded" placeholder="Search work (e.g. Prelude)">
            
             <div class="mt-4 space-y-2">
                 <template x-for="w in workResults" :key="w.id || w.openopus_id">
                     <div @click="selectWork(w)" class="p-2 border rounded hover:bg-gray-100 cursor-pointer bg-gray-50">
                         <span x-text="w.title"></span>
                     </div>
                 </template>
            </div>

            <!-- Lazy Builder Fallback -->
             <div x-show="searchWorkQuery.length > 2" class="mt-4 border p-4 rounded bg-gray-50">
                <h3 class="font-bold text-sm mb-2">Not found? Create a new entry.</h3>
                <div class="flex gap-2 mt-2">
                    <input type="text" x-model="lazyGenre" placeholder="Genre (e.g. Sonata)" class="border p-2 rounded flex-1 text-sm">
                    <input type="text" x-model="lazyKey" placeholder="Key (e.g. C Major)" class="border p-2 rounded flex-1 text-sm">
                </div>
                <button @click="createUnverifiedWork" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">Create & Continue</button>
            </div>
            
            <button @click="step=1" class="mt-6 text-sm text-gray-500 underline">Back to Composer</button>
        </div>

        <!-- Step 3: Scope -->
        <div x-show="step === 3">
             <h2 class="text-xl mb-4">Final Details</h2>
             <div class="mb-6 p-4 bg-blue-50 rounded border border-blue-100">
                 <p class="mb-1"><span class="font-bold text-gray-600 w-24 inline-block">Composer:</span> <span x-text="selectedComposer ? selectedComposer.name : ''"></span></p>
                 <p><span class="font-bold text-gray-600 w-24 inline-block">Work:</span> <span x-text="selectedWork ? selectedWork.title : ''"></span></p>
             </div>
             
             <label class="block mb-2 font-bold text-sm">Scope</label>
             <select x-model="scope" class="w-full border p-2 rounded mb-4">
                 <option value="Whole Work">Whole Work</option>
                 <option value="Movement">Movement</option>
                 <option value="Excerpt">Excerpt</option>
             </select>
             
             <div x-show="scope !== 'Whole Work'">
                 <label class="block mb-2 font-bold text-sm">Details (Movement No. / Bars)</label>
                 <input type="text" x-model="movementDetails" class="w-full border p-2 rounded" placeholder="e.g. I. Allegro">
             </div>
             
             <button @click="submitReport" class="mt-6 bg-green-600 text-white px-6 py-3 rounded font-bold w-full hover:bg-green-700 shadow">Submit Report</button>
             <div x-show="submitStatus" class="mt-4 p-4 rounded text-center" :class="submitSuccess ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                 <p x-text="submitStatus"></p>
             </div>
             
             <button @click="step=2" class="mt-4 text-sm text-gray-500 underline text-center w-full">Back to Work</button>
        </div>
    </div>

    <script>
        function wizard() {
            return {
                step: 1,
                // Composer
                searchComposerQuery: '',
                composerResults: [],
                wikidataResults: [],
                selectedComposer: null,
                
                // Work
                searchWorkQuery: '',
                workResults: [],
                selectedWork: null,
                lazyGenre: '',
                lazyKey: '',

                // Details
                scope: 'Whole Work',
                movementDetails: '',
                
                // Meta
                submitStatus: '',
                submitSuccess: false,
                eventId: {{ event_id }},

                async searchComposer() {
                    if (this.searchComposerQuery.length < 2) return;
                    try {
                        const res = await fetch(`/api/composers/search?q=${this.searchComposerQuery}&source=local`);
                        if (res.ok) this.composerResults = await res.json();
                    } catch (e) { console.error(e); }
                },
                
                async searchWikidata() {
                     try {
                         const res = await fetch(`/api/composers/search?q=${this.searchComposerQuery}&source=wikidata`);
                         if (res.ok) this.wikidataResults = await res.json();
                     } catch (e) { console.error(e); }
                },

                selectComposer(c) {
                    this.selectedComposer = c;
                    this.searchWorkQuery = '';
                    this.workResults = [];
                    this.step = 2;
                },
                
                createUnverifiedComposer() {
                    this.selectedComposer = { name: this.searchComposerQuery, is_verified: false };
                    this.step = 2;
                },

                async searchWork() {
                    if (this.searchWorkQuery.length < 2) return;
                    
                    let url = `/api/works/search?q=${this.searchWorkQuery}&source=local`;
                    if (this.selectedComposer && this.selectedComposer.id) {
                        url += `&composer_id=${this.selectedComposer.id}`;
                    }
                    try {
                        const res = await fetch(url);
                        if (res.ok) this.workResults = await res.json();
                    } catch (e) { console.error(e); }
                },
                
                selectWork(w) {
                    this.selectedWork = w;
                    this.step = 3;
                },
                
                createUnverifiedWork() {
                    const title = (this.lazyGenre + (this.lazyKey ? ' in ' + this.lazyKey : '')).trim() || this.searchWorkQuery;
                    this.selectedWork = { title: title, is_verified: false };
                    this.step = 3;
                },

                async submitReport() {
                    const payload = {
                        event_id: this.eventId,
                        composer: this.selectedComposer,
                        work: this.selectedWork,
                        scope: this.scope,
                        movement_details: this.movementDetails
                    };
                    
                    try {
                        const res = await fetch('/api/reports/', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(payload)
                        });
                        
                        if (res.ok) {
                            this.submitSuccess = true;
                            this.submitStatus = "Success! Report submitted.";
                            setTimeout(() => {
                                // Optional: Redirect or reset
                                window.location.reload(); 
                            }, 2000);
                        } else {
                            const err = await res.json();
                            this.submitSuccess = false;
                            this.submitStatus = "Error: " + (err.detail || "Unknown error");
                        }
                    } catch (e) {
                        this.submitSuccess = false;
                        this.submitStatus = "Error: Network error";
                    }
                }
            }
        }
    </script>
</body>
</html>
