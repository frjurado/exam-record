<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Contribute - Exam Record</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-50 min-h-screen p-6" x-data="wizard({{ event_id }})">
    <div class="max-w-2xl mx-auto bg-white shadow rounded p-6">
        <h1 class="text-2xl font-bold mb-4">Exam Report Wizard</h1>

        <!-- Step Indicator -->
        <div class="mb-6 flex space-x-4 text-sm">
            <span :class="{'font-bold text-blue-600': step===1}">1. Composer</span>
            <span :class="{'font-bold text-blue-600': step===2}">2. Work</span>
            <span :class="{'font-bold text-blue-600': step===3}">3. Details</span>
        </div>

        <!-- Step 1: Composer -->
        <div x-show="step === 1">
            <h2 class="text-xl mb-4">Who is the composer?</h2>
            <input type="text" x-model="searchComposerQuery" @input.debounce.300ms="searchComposer"
                class="w-full border p-2 rounded" placeholder="Search composer (e.g. Bach)">

            <div class="mt-4 space-y-2">
                <template x-for="c in composerResults" :key="c.id || c.wikidata_id">
                    <div @click="selectComposer(c)"
                        class="p-2 border rounded hover:bg-gray-100 cursor-pointer flex justify-between items-center bg-gray-50">
                        <span x-text="c.name"></span>
                        <span x-show="c.is_verified" class="text-green-500 font-bold">âœ“</span>
                    </div>
                </template>
            </div>

            <div x-show="searchComposerQuery.length > 2" class="mt-4 pt-4 border-t">
                <p class="text-gray-500 text-sm mb-2" x-show="composerResults.length === 0">No local results found.</p>
                <div class="flex gap-4 items-center">
                    <button @click="searchWikidata" class="text-blue-600 underline text-sm">Search Global Database
                        (Wikidata)</button>
                    <span class="text-gray-300">|</span>
                    <button @click="createUnverifiedComposer" class="text-gray-600 underline text-sm">Use "<span
                            x-text="searchComposerQuery"></span>" (Unverified)</button>
                </div>

                <div x-show="wikidataResults.length > 0" class="mt-4 bg-blue-50 p-4 rounded">
                    <h3 class="font-bold text-sm text-blue-800 mb-2">Did you mean?</h3>
                    <template x-for="c in wikidataResults" :key="c.wikidata_id">
                        <div @click="selectComposer(c)"
                            class="p-2 border border-blue-100 rounded bg-white hover:bg-blue-100 cursor-pointer mb-1">
                            <div class="font-bold" x-text="c.name"></div>
                            <div class="text-xs text-gray-600" x-text="c.description"></div>
                        </div>
                    </template>
                </div>
                <div x-show="searchComposerQuery.length > 2 && wikidataResults.length === 0 && wikidataSearched"
                    class="mt-4 text-gray-500 text-sm">
                    No results found in global database.
                </div>
            </div>
        </div>

        <!-- Step 2: Work -->
        <div x-show="step === 2">
            <h2 class="text-xl mb-4">Which work?</h2>
            <p class="text-sm text-gray-500 mb-4">Composer: <span class="font-bold text-gray-800"
                    x-text="selectedComposer ? selectedComposer.name : ''"></span></p>

            <input type="text" x-model="searchWorkQuery" @input.debounce.300ms="searchWork"
                class="w-full border p-2 rounded" placeholder="Search work (e.g. Prelude)">

            <div class="mt-4 space-y-2">
                <template x-for="w in workResults" :key="w.id || w.openopus_id">
                    <div @click="selectWork(w)" class="p-2 border rounded hover:bg-gray-100 cursor-pointer bg-gray-50">
                        <span x-text="w.title"></span>
                        <span x-show="w.nickname" x-text="`(${w.nickname})`" class="text-xs text-gray-500 ml-1"></span>
                    </div>
                </template>
            </div>

            <!-- Lazy Builder Fallback -->
            <div x-show="searchWorkQuery.length > 2" class="mt-4 border p-4 rounded bg-gray-50">
                <h3 class="font-bold text-sm mb-2">Not found? Create a new entry.</h3>
                <div class="space-y-2 mt-2">
                    <div class="flex gap-2">
                        <input type="text" x-model="lazyGenre" @input.debounce.500ms="updateLazySearch"
                            placeholder="Genre (e.g. Sonata)" class="border p-2 rounded flex-1 text-sm">
                        <input type="text" x-model="lazyKey" @input.debounce.500ms="updateLazySearch"
                            placeholder="Key (e.g. C Major)" class="border p-2 rounded flex-1 text-sm">
                    </div>
                    <div class="flex gap-2">
                        <input type="text" x-model="lazyOpus" @input.debounce.500ms="updateLazySearch"
                            placeholder="Opus (e.g. 57)" class="border p-2 rounded flex-1 text-sm">
                        <input type="text" x-model="lazyNumber" @input.debounce.500ms="updateLazySearch"
                            placeholder="No. (e.g. 23)" class="border p-2 rounded flex-1 text-sm">
                    </div>
                </div>
                <button @click="createUnverifiedWork"
                    class="mt-2 bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">Create &
                    Continue</button>
            </div>

            <button @click="step=1; searchComposerQuery=''; composerResults=[]; wikidataResults=[]"
                class="mt-6 text-sm text-gray-500 underline">Back to Composer</button>
        </div>

        <!-- Step 3: Scope -->
        <div x-show="step === 3">
            <h2 class="text-xl mb-4">Final Details</h2>
            <div class="mb-6 p-4 bg-blue-50 rounded border border-blue-100">
                <p class="mb-1"><span class="font-bold text-gray-600 w-24 inline-block">Composer:</span> <span
                        x-text="selectedComposer ? selectedComposer.name : ''"></span></p>
                <p><span class="font-bold text-gray-600 w-24 inline-block">Work:</span> <span
                        x-text="selectedWork ? selectedWork.title : ''"></span></p>
            </div>

            <label class="block mb-2 font-bold text-sm">Scope</label>
            <select x-model="scope" class="w-full border p-2 rounded mb-4">
                <option value="Whole Work">Whole Work</option>
                <option value="Movement">Movement</option>
                <option value="Excerpt">Excerpt</option>
            </select>

            <div x-show="scope !== 'Whole Work'">
                <label class="block mb-2 font-bold text-sm">Details (Movement No. / Bars)</label>
                <input type="text" x-model="movementDetails" class="w-full border p-2 rounded"
                    placeholder="e.g. I. Allegro">
            </div>

            <button @click="submitReport"
                class="mt-6 bg-green-600 text-white px-6 py-3 rounded font-bold w-full hover:bg-green-700 shadow">Submit
                Report</button>
            <div x-show="submitStatus" class="mt-4 p-4 rounded text-center"
                :class="submitSuccess ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                <p x-text="submitStatus"></p>
            </div>

            <div class="flex gap-4 mt-4">
                <button @click="step=2" class="text-sm text-gray-500 underline flex-1 text-center">Back to Work</button>
                <button @click="hardReset" class="text-sm text-red-400 underline flex-1 text-center">Reset Form</button>
            </div>
        </div>
        <!-- Auth Modal -->
        <div x-show="showAuthModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"
            style="display: none;">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">

                <!-- Initial State: Ask for Email -->
                <div x-show="!magicLinkSent" class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Email Verification Required</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500">
                            To maintain data quality, please verify your email. We'll send you a magic link.
                        </p>
                        <input type="email" x-model="authEmail" class="mt-4 w-full border p-2 rounded"
                            placeholder="pianist@example.com">
                    </div>
                    <div class="items-center px-4 py-3">
                        <button @click="requestMagicLink" :disabled="!authEmail"
                            :class="{'opacity-50 cursor-not-allowed': !authEmail}"
                            class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                            Send Magic Link
                        </button>
                        <button @click="showAuthModal = false"
                            class="mt-2 text-sm text-gray-500 underline">Cancel</button>
                    </div>
                </div>

                <!-- Sent State: Instructions -->
                <div x-show="magicLinkSent" class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                        <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Magic Link Sent!</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500">
                            Please check your email <strong><span x-text="authEmail"></span></strong>.
                        </p>
                        <p class="text-sm text-gray-500 mt-2">
                            Click the link in the email to return here and submit your report.
                        </p>
                        <div class="mt-4 p-2 bg-blue-50 text-xs text-blue-800 rounded text-left">
                            <strong>Next:</strong> Click the link in your email. It will bring you back here and
                            <strong>automatically submit your report</strong>.
                        </div>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button @click="showAuthModal = false"
                            class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">
                            Close
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <script>
            function wizard(eventId) {
                return {
                    step: 1,
                    // Composer
                    searchComposerQuery: '',
                    composerResults: [],
                    wikidataResults: [],
                    wikidataSearched: false,
                    selectedComposer: null,

                    // Work
                    searchWorkQuery: '',
                    workResults: [],
                    selectedWork: null,
                    lazyGenre: '',
                    lazyKey: '',
                    lazyOpus: '',
                    lazyNumber: '',

                    // Details
                    scope: 'Whole Work',
                    movementDetails: '',

                    // Auth
                    isAuthenticated: false,
                    showAuthModal: false,
                    authEmail: '',
                    magicLinkSent: false,
                    pendingSubmission: false,

                    // Meta
                    submitStatus: '',
                    submitSuccess: false,
                    eventId: eventId,

                    async init() {
                        this.restoreState();
                        await this.checkAuth();

                        // Watch for changes to persist state
                        this.$watch('step', () => this.saveState());
                        this.$watch('selectedComposer', () => this.saveState());
                        this.$watch('selectedWork', () => this.saveState());
                        this.$watch('scope', () => this.saveState());
                        this.$watch('movementDetails', () => this.saveState());

                        // Auto-submit check
                        if (this.isAuthenticated && this.step === 3 && this.pendingSubmission) {
                            console.log("Auto-submitting...");
                            this.submitStatus = "Verifying and submitting...";
                            await this.submitReport();
                        }
                    },

                    saveState() {
                        const state = {
                            step: this.step,
                            selectedComposer: this.selectedComposer,
                            selectedWork: this.selectedWork,
                            scope: this.scope,
                            movementDetails: this.movementDetails,
                            eventId: this.eventId,
                            pendingSubmission: this.pendingSubmission || false
                        };
                        localStorage.setItem('wizardState_' + this.eventId, JSON.stringify(state));
                    },

                    restoreState() {
                        const saved = localStorage.getItem('wizardState_' + this.eventId);
                        if (saved) {
                            const state = JSON.parse(saved);
                            this.step = state.step || 1;
                            this.selectedComposer = state.selectedComposer;
                            this.selectedWork = state.selectedWork;
                            this.scope = state.scope || 'Whole Work';
                            this.movementDetails = state.movementDetails || '';
                            this.pendingSubmission = state.pendingSubmission || false;
                        }
                    },

                    clearState() {
                        localStorage.removeItem('wizardState_' + this.eventId);
                        // Also clear specific fields
                        this.step = 1;
                        this.selectedComposer = null;
                        this.selectedWork = null;
                        this.scope = 'Whole Work';
                        this.movementDetails = '';
                    },

                    hardReset() {
                        if (confirm("Are you sure you want to clear the form?")) {
                            this.clearState();
                            window.location.reload();
                        }
                    },

                    async checkAuth() {
                        try {
                            const res = await fetch('/api/auth/me', { credentials: 'include' });
                            if (res.ok) {
                                this.isAuthenticated = true;
                                if (this.step === 3) {
                                    // Optional: Auto-submit if desired, but safer to let user click
                                    this.submitStatus = "";
                                }
                            } else {
                                this.isAuthenticated = false;
                            }
                        } catch (e) {
                            this.isAuthenticated = false;
                        }
                    },

                    async requestMagicLink() {
                        if (!this.authEmail) return;
                        try {
                            const payload = {
                                email: this.authEmail,
                                next_url: window.location.href // This ensures we come back here
                            };

                            const res = await fetch('/api/auth/magic-link', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            if (res.ok) {
                                this.magicLinkSent = true;
                                this.pendingSubmission = true; // Mark intention to submit
                                this.saveState(); // Ensure state is saved before they leave
                            }
                        } catch (e) {
                            console.error("Magic link failed", e);
                        }
                    },

                    async searchComposer() {
                        if (this.searchComposerQuery.length < 2) {
                            this.composerResults = [];
                            this.wikidataResults = [];
                            return;
                        }
                        try {
                            const res = await fetch(`/api/composers/search?q=${this.searchComposerQuery}&source=local`);
                            if (res.ok) this.composerResults = await res.json();
                        } catch (e) { console.error(e); }
                    },

                    async searchWikidata() {
                        this.wikidataResults = [];
                        this.wikidataSearched = false;
                        try {
                            const res = await fetch(`/api/composers/search?q=${this.searchComposerQuery}&source=wikidata`);
                            this.wikidataSearched = true;
                            if (res.ok) {
                                this.wikidataResults = await res.json();
                            }
                        } catch (e) { console.error(e); }
                    },

                    selectComposer(c) {
                        this.selectedComposer = c;
                        this.searchWorkQuery = '';
                        this.workResults = [];
                        // Reset lazy builder
                        this.lazyGenre = '';
                        this.lazyKey = '';
                        this.lazyOpus = '';
                        this.lazyNumber = '';
                        this.step = 2;
                    },

                    createUnverifiedComposer() {
                        const name = this.searchComposerQuery;
                        this.selectedComposer = { name: name, is_verified: false };
                        this.step = 2;
                    },

                    async searchWork() {
                        const query = this.searchWorkQuery;
                        if (query.length < 2) {
                            this.workResults = [];
                            return;
                        }

                        // If composer is wikidata-only (not in DB yet), don't search local works
                        // or if unverified. Only search local if we have a local ID.
                        if (!this.selectedComposer.id) {
                            this.workResults = [];
                            return;
                        }

                        let url = `/api/works/search?q=${query}&source=local`;
                        if (this.selectedComposer && this.selectedComposer.id) {
                            url += `&composer_id=${this.selectedComposer.id}`;
                        }
                        try {
                            const res = await fetch(url);
                            if (res.ok) this.workResults = await res.json();
                        } catch (e) {
                            console.error(e);
                            this.workResults = [];
                        }
                    },

                    // Live search for Lazy Builder
                    updateLazySearch() {
                        const parts = [
                            this.lazyGenre,
                            this.lazyKey,
                            this.lazyOpus ? 'Op. ' + this.lazyOpus : '',
                            this.lazyNumber ? 'No. ' + this.lazyNumber : ''
                        ];
                        // Join non-empty parts
                        const validParts = parts.filter(p => p && p.trim().length > 0);
                        const potentialTitle = validParts.join(' ');

                        if (potentialTitle.length > 2) {
                            this.searchWorkQuery = potentialTitle;
                            // Only search if we have a composer ID to search against
                            if (this.selectedComposer.id) {
                                this.searchWork();
                            } else {
                                this.workResults = [];
                            }
                        }
                    },

                    selectWork(w) {
                        this.selectedWork = w;
                        this.step = 3;
                    },

                    createUnverifiedWork() {
                        const parts = [
                            this.lazyGenre,
                            this.lazyKey ? 'in ' + this.lazyKey : '',
                            this.lazyOpus ? 'Op. ' + this.lazyOpus : '',
                            this.lazyNumber ? 'No. ' + this.lazyNumber : ''
                        ];
                        const title = parts.filter(p => p && p.trim().length > 0).join(' ').trim() || this.searchWorkQuery;

                        this.selectedWork = { title: title, is_verified: false };
                        this.step = 3;
                    },

                    async submitReport() {
                        if (!this.isAuthenticated) {
                            this.showAuthModal = true;
                            return;
                        }

                        const payload = {
                            event_id: this.eventId,
                            composer: this.selectedComposer,
                            work: this.selectedWork,
                            scope: this.scope,
                            movement_details: this.movementDetails
                        };

                        try {
                            const res = await fetch('/api/reports/', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload),
                                credentials: 'include'
                            });

                            if (res.ok) {
                                this.submitSuccess = true;
                                this.submitStatus = "Success! Report submitted.";
                                this.clearState(); // Clear stored state on success
                                setTimeout(() => {
                                    // Redirect to event page (remove /contribute from URL)
                                    window.location.href = window.location.href.replace('/contribute', '');
                                }, 2000);
                            } else {
                                const err = await res.json();
                                this.submitSuccess = false;
                                this.submitStatus = "Error: " + (err.detail || "Unknown error");
                            }
                        } catch (e) {
                            this.submitSuccess = false;
                            this.submitStatus = "Error: Network error";
                        }
                    }
                }
            }
        </script>
</body>

</html>